{"ast":null,"code":"import _asyncToGenerator from \"D:/Luftborn/MiniCommerce-FrontEnd-Luftborn/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { BehaviorSubject, firstValueFrom } from 'rxjs';\nimport { environment } from '../../../environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"angular-oauth2-oidc\";\nimport * as i2 from \"./auth-config.service\";\nexport class AuthService {\n  oauthService;\n  authConfigService;\n  ssoEnabled$ = new BehaviorSubject(false);\n  initialized = false;\n  constructor(oauthService, authConfigService) {\n    this.oauthService = oauthService;\n    this.authConfigService = authConfigService;\n  }\n  init() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      if (_this.initialized) return;\n      const config = yield firstValueFrom(_this.authConfigService.getSsoConfig());\n      _this.ssoEnabled$.next(config.enabled);\n      if (config.enabled && config.authority && config.clientId) {\n        const authConfig = {\n          issuer: config.authority,\n          clientId: config.clientId,\n          redirectUri: window.location.origin + '/login',\n          postLogoutRedirectUri: window.location.origin + '/',\n          responseType: 'code',\n          scope: 'openid profile email',\n          strictDiscoveryDocumentValidation: false,\n          showDebugInformation: !environment.production\n        };\n        if (config.audience) {\n          authConfig.customQueryParams = {\n            audience: config.audience\n          };\n        }\n        _this.oauthService.configure(authConfig);\n        // ✅ best practice\n        yield _this.oauthService.loadDiscoveryDocumentAndTryLogin();\n        // ✅ silent refresh\n        _this.oauthService.setupAutomaticSilentRefresh();\n      }\n      _this.initialized = true;\n    })();\n  }\n  get isSsoEnabled() {\n    return this.ssoEnabled$.value;\n  }\n  get isAuthenticated() {\n    return this.oauthService.hasValidAccessToken();\n  }\n  login() {\n    this.oauthService.initCodeFlow();\n  }\n  logout() {\n    this.oauthService.logOut();\n  }\n  getAccessToken() {\n    return this.oauthService.getAccessToken();\n  }\n  get claims() {\n    return this.oauthService.getIdentityClaims() ?? {};\n  }\n  get name() {\n    return this.claims['name'] ?? this.claims['preferred_username'] ?? '';\n  }\n  static ɵfac = function AuthService_Factory(__ngFactoryType__) {\n    return new (__ngFactoryType__ || AuthService)(i0.ɵɵinject(i1.OAuthService), i0.ɵɵinject(i2.AuthConfigService));\n  };\n  static ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: AuthService,\n    factory: AuthService.ɵfac,\n    providedIn: 'root'\n  });\n}","map":{"version":3,"names":["BehaviorSubject","firstValueFrom","environment","AuthService","oauthService","authConfigService","ssoEnabled$","initialized","constructor","init","_this","_asyncToGenerator","config","getSsoConfig","next","enabled","authority","clientId","authConfig","issuer","redirectUri","window","location","origin","postLogoutRedirectUri","responseType","scope","strictDiscoveryDocumentValidation","showDebugInformation","production","audience","customQueryParams","configure","loadDiscoveryDocumentAndTryLogin","setupAutomaticSilentRefresh","isSsoEnabled","value","isAuthenticated","hasValidAccessToken","login","initCodeFlow","logout","logOut","getAccessToken","claims","getIdentityClaims","name","i0","ɵɵinject","i1","OAuthService","i2","AuthConfigService","factory","ɵfac","providedIn"],"sources":["D:\\Luftborn\\MiniCommerce-FrontEnd-Luftborn\\src\\app\\core\\services\\auth.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { OAuthService, AuthConfig } from 'angular-oauth2-oidc';\r\nimport { BehaviorSubject, firstValueFrom } from 'rxjs';\r\nimport { environment } from '../../../environments/environment';\r\nimport { AuthConfigService } from './auth-config.service';\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class AuthService {\r\n  private readonly ssoEnabled$ = new BehaviorSubject<boolean>(false);\r\n  private initialized = false;\r\n\r\n  constructor(\r\n    private oauthService: OAuthService,\r\n    private authConfigService: AuthConfigService\r\n  ) {}\r\n\r\n  async init(): Promise<void> {\r\n    if (this.initialized) return;\r\n\r\n    const config = await firstValueFrom(\r\n      this.authConfigService.getSsoConfig()\r\n    );\r\n\r\n    this.ssoEnabled$.next(config.enabled);\r\n\r\n    if (config.enabled && config.authority && config.clientId) {\r\n\r\n      const authConfig: AuthConfig = {\r\n        issuer: config.authority,\r\n        clientId: config.clientId,\r\n\r\n        redirectUri: window.location.origin + '/login',\r\n        postLogoutRedirectUri: window.location.origin + '/',\r\n\r\n        responseType: 'code',\r\n        scope: 'openid profile email',\r\n\r\n        strictDiscoveryDocumentValidation: false,\r\n        showDebugInformation: !environment.production,\r\n      };\r\n\r\n      if (config.audience) {\r\n        authConfig.customQueryParams = { audience: config.audience };\r\n      }\r\n\r\n      this.oauthService.configure(authConfig);\r\n\r\n      // ✅ best practice\r\n      await this.oauthService.loadDiscoveryDocumentAndTryLogin();\r\n\r\n      // ✅ silent refresh\r\n      this.oauthService.setupAutomaticSilentRefresh();\r\n    }\r\n\r\n    this.initialized = true;\r\n  }\r\n\r\n  get isSsoEnabled(): boolean {\r\n    return this.ssoEnabled$.value;\r\n  }\r\n\r\n  get isAuthenticated(): boolean {\r\n    return this.oauthService.hasValidAccessToken();\r\n  }\r\n\r\n  login(): void {\r\n    this.oauthService.initCodeFlow();\r\n  }\r\n\r\n  logout(): void {\r\n    this.oauthService.logOut();\r\n  }\r\n\r\n  getAccessToken(): string | null {\r\n    return this.oauthService.getAccessToken();\r\n  }\r\n\r\n  get claims(): Record<string, unknown> {\r\n    return (this.oauthService.getIdentityClaims() as any) ?? {};\r\n  }\r\n\r\n  get name(): string {\r\n    return (\r\n      (this.claims['name'] as string) ??\r\n      (this.claims['preferred_username'] as string) ??\r\n      ''\r\n    );\r\n  }\r\n}\r\n"],"mappings":";AAEA,SAASA,eAAe,EAAEC,cAAc,QAAQ,MAAM;AACtD,SAASC,WAAW,QAAQ,mCAAmC;;;;AAI/D,OAAM,MAAOC,WAAW;EAKZC,YAAA;EACAC,iBAAA;EALOC,WAAW,GAAG,IAAIN,eAAe,CAAU,KAAK,CAAC;EAC1DO,WAAW,GAAG,KAAK;EAE3BC,YACUJ,YAA0B,EAC1BC,iBAAoC;IADpC,KAAAD,YAAY,GAAZA,YAAY;IACZ,KAAAC,iBAAiB,GAAjBA,iBAAiB;EACxB;EAEGI,IAAIA,CAAA;IAAA,IAAAC,KAAA;IAAA,OAAAC,iBAAA;MACR,IAAID,KAAI,CAACH,WAAW,EAAE;MAEtB,MAAMK,MAAM,SAASX,cAAc,CACjCS,KAAI,CAACL,iBAAiB,CAACQ,YAAY,EAAE,CACtC;MAEDH,KAAI,CAACJ,WAAW,CAACQ,IAAI,CAACF,MAAM,CAACG,OAAO,CAAC;MAErC,IAAIH,MAAM,CAACG,OAAO,IAAIH,MAAM,CAACI,SAAS,IAAIJ,MAAM,CAACK,QAAQ,EAAE;QAEzD,MAAMC,UAAU,GAAe;UAC7BC,MAAM,EAAEP,MAAM,CAACI,SAAS;UACxBC,QAAQ,EAAEL,MAAM,CAACK,QAAQ;UAEzBG,WAAW,EAAEC,MAAM,CAACC,QAAQ,CAACC,MAAM,GAAG,QAAQ;UAC9CC,qBAAqB,EAAEH,MAAM,CAACC,QAAQ,CAACC,MAAM,GAAG,GAAG;UAEnDE,YAAY,EAAE,MAAM;UACpBC,KAAK,EAAE,sBAAsB;UAE7BC,iCAAiC,EAAE,KAAK;UACxCC,oBAAoB,EAAE,CAAC1B,WAAW,CAAC2B;SACpC;QAED,IAAIjB,MAAM,CAACkB,QAAQ,EAAE;UACnBZ,UAAU,CAACa,iBAAiB,GAAG;YAAED,QAAQ,EAAElB,MAAM,CAACkB;UAAQ,CAAE;QAC9D;QAEApB,KAAI,CAACN,YAAY,CAAC4B,SAAS,CAACd,UAAU,CAAC;QAEvC;QACA,MAAMR,KAAI,CAACN,YAAY,CAAC6B,gCAAgC,EAAE;QAE1D;QACAvB,KAAI,CAACN,YAAY,CAAC8B,2BAA2B,EAAE;MACjD;MAEAxB,KAAI,CAACH,WAAW,GAAG,IAAI;IAAC;EAC1B;EAEA,IAAI4B,YAAYA,CAAA;IACd,OAAO,IAAI,CAAC7B,WAAW,CAAC8B,KAAK;EAC/B;EAEA,IAAIC,eAAeA,CAAA;IACjB,OAAO,IAAI,CAACjC,YAAY,CAACkC,mBAAmB,EAAE;EAChD;EAEAC,KAAKA,CAAA;IACH,IAAI,CAACnC,YAAY,CAACoC,YAAY,EAAE;EAClC;EAEAC,MAAMA,CAAA;IACJ,IAAI,CAACrC,YAAY,CAACsC,MAAM,EAAE;EAC5B;EAEAC,cAAcA,CAAA;IACZ,OAAO,IAAI,CAACvC,YAAY,CAACuC,cAAc,EAAE;EAC3C;EAEA,IAAIC,MAAMA,CAAA;IACR,OAAQ,IAAI,CAACxC,YAAY,CAACyC,iBAAiB,EAAU,IAAI,EAAE;EAC7D;EAEA,IAAIC,IAAIA,CAAA;IACN,OACG,IAAI,CAACF,MAAM,CAAC,MAAM,CAAY,IAC9B,IAAI,CAACA,MAAM,CAAC,oBAAoB,CAAY,IAC7C,EAAE;EAEN;;qCAhFWzC,WAAW,EAAA4C,EAAA,CAAAC,QAAA,CAAAC,EAAA,CAAAC,YAAA,GAAAH,EAAA,CAAAC,QAAA,CAAAG,EAAA,CAAAC,iBAAA;EAAA;;WAAXjD,WAAW;IAAAkD,OAAA,EAAXlD,WAAW,CAAAmD,IAAA;IAAAC,UAAA,EADE;EAAM","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}